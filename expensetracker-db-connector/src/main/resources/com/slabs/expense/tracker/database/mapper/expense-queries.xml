<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.slabs.expense.tracker.common.database.mapper.ExpenseDAO">



	<insert id="insertExpense" parameterType="java.util.List">
		insert into EXPENSETRACKER.EXPENSE(ITEMNAME,CATEGORY,EXPTYPE,QTY,PRICE,EXPDATE,USERNAME,PRICEPERUNIT, INVENTORYIND) values
		<foreach collection="list" item="record" index="index" open="(" separator="),(" close=")">
			#{record.itemName},
			#{record.category},
			#{record.exptype},
			#{record.qty},
			#{record.price},
			#{record.expdate},
			#{record.username},
			#{record.pricePerUnit},
			#{record.inventoryInd}
		</foreach>
	</insert>

	<update id="updateExpense">
		update EXPENSETRACKER.EXPENSE
		<set>
			<if test="itemName != null">
				itemName = #{itemName},
			</if>
			<if test="category != null">
				category=#{category},
			</if>
			<if test="exptype != null">
				exptype=#{exptype},
			</if>
			<if test="expdate != null">
				expdate=#{expdate},
			</if>
			<if test="price != null">
				price=#{price},
			</if>
			<if test="qty != null">
				qty=#{qty},
			</if>
			<if test="pricePerUnit != null">
				pricePerUnit=#{pricePerUnit},
			</if>
			<if test="inventoryInd != null">
				inventoryInd=#{inventoryInd}
			</if>
		</set>
		where id=#{id}
	</update>

	<select id="getExpense" resultType="com.slabs.expense.tracker.common.database.entity.Expense">
		select * from EXPENSETRACKER.EXPENSE where
		username=#{param1}
		<if test="param2 != null">
			and YEAR(expdate)=#{param2}
		</if>
		<if test="param3 != null">
			and MONTH(expdate) = #{param3}
		</if>
	</select>

	<select id="getTopExpense" resultType="com.slabs.expense.tracker.common.database.entity.Expense">
		select * from EXPENSETRACKER.EXPENSE where price in (
		select max(price) from expense where username=#{param1}
		and YEAR(expdate) = #{param2}
		<if test="param3 != null">
			and MONTH(expdate) = #{param3}
		</if>
		group by category)
		and username=#{param1}
		and YEAR(expdate)=#{param2}
		<if test="param3 != null">
			and MONTH(expdate) = #{param3}
		</if>
	</select>

	<select id="getTotalExpense" resultType="java.lang.Double">
		select sum(price) from EXPENSETRACKER.EXPENSE where
		username=#{param1}
		<if test="param2 != null">
			and YEAR(expdate)=#{param2}
		</if>
		<if test="param3 != null">
			and MONTH(expdate) = #{param3}
		</if>
	</select>

	<select id="getMonthWiseTotalExpense" resultType="com.slabs.expense.tracker.common.database.entity.Graph">
		select month(expdate) as MONTH, sum(price) as EXPENSE from EXPENSE where
		username =
		#{param1} and
		year(expdate) = #{param2}
		group by month(expdate)
	</select>

	<select id="getCategoryWiseTotalExpense" resultType="com.slabs.expense.tracker.common.database.entity.Graph">
		select category, sum(price) as EXPENSE from EXPENSE
		where username=#{param1} and year(expdate) = #{param2}
		<if test="param3 != null">
			and MONTH(expdate) = #{param3}
		</if>
		group by category
	</select>


	<select id="getExpenseById" resultType="com.slabs.expense.tracker.common.database.entity.Expense">
		select * from EXPENSETRACKER.EXPENSE where
		id=#{param1}
	</select>

	<select id="selectExpenseNames" resultType="com.slabs.expense.tracker.common.database.entity.Dictionary">
		select distinct itemname from EXPENSETRACKER.EXPENSE
	</select>

	<delete id="deleteExpense">
		delete from EXPENSETRACKER.EXPENSE
		where id=#{id}
	</delete>

	<insert id="insertExpenseCategory" parameterType="java.util.List">
		insert into EXPENSETRACKER.EXPENSE_CATEGORY(CATEGORY,DESCRIPTION,USERNAME) values
		<foreach collection="list" item="record" index="index" open="(" separator="),(" close=")">
			#{record.category},
			#{record.description},
			#{record.username}
		</foreach>
	</insert>

	<update id="updateExpenseCategory" parameterType="com.slabs.expense.tracker.common.database.entity.ExpenseCategory">

		update EXPENSETRACKER.EXPENSE_CATEGORY
		<set>
			<if test="category != null">
				category=#{category},
			</if>
			<if test="description != null">
				description=#{description}
			</if>
		</set>
		where categoryId=#{categoryId}

	</update>

	<select id="retrieveExpenseCategory" resultType="com.slabs.expense.tracker.common.database.entity.ExpenseCategory">
		select * from EXPENSETRACKER.EXPENSE_CATEGORY where username=#{param1}
	</select>

	<delete id="deleteExpenseCategory">
		delete from EXPENSETRACKER.EXPENSE_CATEGORY
		<if test="categoryId != null">
			where categoryId=#{categoryId}
		</if>
	</delete>
	
</mapper>