<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.slabs.expense.tracker.database.mapper.UserDAO">

	<insert id="createUser" parameterType="com.slabs.expense.tracker.common.db.entity.UserInfo">
		insert into EXPENSETRACKER.USERINFO(FIRSTNAME, LASTNAME, SEX, USERNAME,PASSWORD,EMAIL,MOBILE,ADDRESS)
		values(
		#{record.firstName},
		#{record.lastName},
		#{record.sex},
		#{record.username},
		#{record.password},
		#{record.email},
		#{record.mobile},
		#{record.address}
		)
	</insert>

	<update id="updateUser">
		update EXPENSETRACKER.USERINFO
		<set>
			<if test="record.firstName != null">
				firstName=#{record.firstName},
			</if>
			<if test="record.lastName != null">
				lastName=#{record.lastName},
			</if>
			<if test="record.sex != null">
				sex=#{record.sex},
			</if>
			<if test="record.newPassword != null">
				password=#{record.newPassword},
			</if>
			<if test="record.email != null">
				email=#{record.email},
			</if>
			<if test="record.mobile != null">
				mobile=#{record.mobile},
			</if>
			<if test="record.address != null">
				address=#{record.address}
			</if>
		</set>
		where username=#{record.username}
	</update>

	<resultMap type="com.slabs.expense.tracker.common.db.entity.UserInfo" id="userMap">
		<result property="firstName" column="FIRSTNAME" />
		<result property="lastName" column="LASTNAME" />
		<result property="sex" column="SEX" />
		<result property="username" column="USERNAME" />
		<result property="password" column="PASSWORD" />
		<result property="email" column="EMAIL" />
		<result property="mobile" column="MOBILE" />
		<result property="address" column="ADDRESS" />
		<association property="feature" javaType="com.slabs.expense.tracker.common.db.entity.Feature">
			<result property="username" column="USERNAME" />
			<result property="isAdmin" column="ISADMIN" />
			<result property="isVerified" column="ISVERIFIED" />
			<result property="isFtLogin" column="ISFTLOGIN" />
		</association>
	</resultMap>

	<select id="getUser" resultMap="userMap">
		select U.FIRSTNAME, U.LASTNAME, U.SEX, U.USERNAME, U.EMAIL, U.MOBILE, U.ADDRESS, F.ISADMIN, F.ISFTLOGIN, F.ISVERIFIED, F.ISLOCKED
		<if test="includePassword">
			,U.PASSWORD
		</if>
		from EXPENSETRACKER.USERINFO U
		LEFT OUTER JOIN EXPENSETRACKER.FEATURE F
		ON U.USERNAME = F.USERNAME
		<if test="username != null">
			where U.USERNAME=#{username}
		</if>
	</select>

	<delete id="deleteUser">
		delete from EXPENSETRACKER.USERINFO where username=#{record.username}
	</delete>

	<insert id="insertUserFeature" parameterType="com.slabs.expense.tracker.common.db.entity.Feature">
		insert into EXPENSETRACKER.FEATURE(USERNAME, ISADMIN, ISVERIFIED, ISFTLOGIN, ISLOCKED)
		values(
		#{record.username},
		#{record.isAdmin},
		#{record.isVerified},
		#{record.isFtLogin},
		#{record.isLocked}
		)
	</insert>

	<update id="updateUserFeature" parameterType="com.slabs.expense.tracker.common.db.entity.Feature">
		update EXPENSETRACKER.FEATURE
		<set>
			<if test="record.isAdmin != null">
				isAdmin=#{record.isAdmin},
			</if>
			<if test="record.isVerified != null">
				isVerified=#{record.isVerified},
			</if>
			<if test="record.isFtLogin != null">
				isFtLogin=#{record.isFtLogin},
			</if>
			<if test="record.isLocked != null">
				isLocked=#{record.isLocked},
			</if>
		</set>
		where username=#{record.username}
	</update>

	<update id="setActivationKey">
		update EXPENSETRACKER.FEATURE set activationKey=#{activationKey} where username=#{username}
	</update>

	<delete id="deleteUserFeature">
		delete from EXPENSETRACKER.FEATURE where username=#{username}
	</delete>

	<select id="getUserFeature" resultType="com.slabs.expense.tracker.common.db.entity.Feature">
		select * from EXPENSETRACKER.FEATURE where username=#{username}
	</select>

	<insert id="insertMessage" parameterType="java.util.List">
		insert into EXPENSETRACKER.MESSAGE(USERNAME, MSGFROM, SUBJECT, MESSAGE, ISNEW) values
		<foreach collection="records" item="record" index="index" open="(" separator="),(" close=")">
			#{record.username},
			#{record.msgfrom},
			#{record.subject},
			#{record.message},
			#{record.isNew}
		</foreach>
	</insert>

	<update id="updateMessage" parameterType="com.slabs.expense.tracker.common.db.entity.Message">
		update EXPENSETRACKER.MESSAGE
		<set>
			<if test="record.subject != null">
				subject=#{record.subject},
			</if>
			<if test="record.message != null">
				message=#{record.message},
			</if>
			<if test="record.msgfrom != null">
				msgfrom=#{record.msgfrom},
			</if>
			<if test="record.msgfrom != null">
				isnew=#{record.isNew},
			</if>
		</set>
		where username=#{record.username}
	</update>

	<delete id="deleteMessage">
		delete from EXPENSETRACKER.MESSAGE
		where id=#{record.id}
		<if test="isDeleteOldMsg">
			and isNew = 'N'
		</if>
	</delete>

	<select id="getMessage" resultType="com.slabs.expense.tracker.common.db.entity.Message">
		select * from EXPENSETRACKER.MESSAGE where username=#{username}
	</select>

</mapper>